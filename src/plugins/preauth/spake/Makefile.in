mydir=plugins$(S)preauth$(S)spake
BUILDTOP=$(REL)..$(S)..$(S)..
MODULE_INSTALL_DIR = $(KRB5_PA_MODULE_DIR)

# Like RUN_TEST, but use t_krb5.conf from this directory.
RUN_TEST_LOCAL_CONF=$(RUN_SETUP) KRB5_CONFIG=$(srcdir)/t_krb5.conf LC_ALL=C \
	$(VALGRIND)

LIBBASE=spake
LIBMAJOR=0
LIBMINOR=0
RELDIR=../plugins/preauth/spake
SHLIB_EXPDEPS=$(KRB5_BASE_DEPLIBS)
SHLIB_EXPLIBS=$(KRB5_BASE_LIBS) $(SPAKE_OPENSSL_LIBS)

DLL_NAME=spake32
DEF_FILE=spake.def
!if ("$(CPU)" == "IA64") || ("$(CPU)" == "AMD64") || ("$(CPU)" == "ALPHA64")
DLL_NAME=spake64
!endif
WINDLLFLAGS = /nologo /dll /incremental:no /release
WINLIBS = $(SLIB) $(KLIB) $(CLIB)

STLIBOBJS=util.o iana.o groups.o openssl.o edwards25519.o \
	spake_client.o spake_kdc.o

SRCS= \
	$(srcdir)/util.c \
	$(srcdir)/iana.c \
	$(srcdir)/groups.c \
	$(srcdir)/openssl.c \
	$(srcdir)/edwards25519.c \
	$(srcdir)/spake_client.c \
	$(srcdir)/spake_kdc.c

OBJS=	$(OUTPRE)util.$(OBJEXT) \
	$(OUTPRE)iana.$(OBJEXT) \
	$(OUTPRE)groups.$(OBJEXT) \
	$(OUTPRE)openssl.$(OBJEXT) \
	$(OUTPRE)edwards25519.$(OBJEXT) \
	$(OUTPRE)spake_client.$(OBJEXT) \
	$(OUTPRE)spake_kdc.$(OBJEXT)

t_vectors: t_vectors.o $(STLIBOBJS) $(SHLIB_EXPDEPS)
	$(CC_LINK) -o $@ t_vectors.o $(STLIBOBJS) $(SHLIB_EXPLIBS)

all-unix: all-liblinks
install-unix: install-libs
clean-unix:: clean-liblinks clean-libs clean-libobjs

check-unix: t_vectors
	$(RUN_TEST_LOCAL_CONF) ./t_vectors

all-windows: $(OUTPRE)$(DLL_NAME).dll
clean-windows::
	$(RM) $(OUTPRE)$(DLL_NAME).dll

$(OUTPRE)$(DLL_NAME).dll: $(DEF_FILE) $(OBJS)
	link $(WINDLLFLAGS) -def:$(DEF_FILE) -out:$*.dll $(OBJS) $(WINLIBS)

@libnover_frag@
@libobj_frag@
